<!doctype html>
<html>
    <head>
        <title>Websocket</title>
        <script src="http://code.jquery.com/jquery-2.0.0.js"></script>
    </head>
<body>
    <h1>Protocol Latency Test</h1>
    <label id="conn_text"></label><br />
    <label id="response_txt"></label><br />        
    <div class="test_row">
        <input type="submit" id="websocketTest" value="Run Websocket Test" />
        <!--<label id="ws_avg"></label>
        <label id="ws_max"></label>
        <label id="ws_min"></label>-->
        <label id="ws_result"></label>
    </div>
    <div class="test_row">
        <input type="submit" id="mqttTest" value="Run MQTT Test" />
        <label id="mqtt_avg"></label>
        <label id="mqtt_max"></label>
        <label id="mqtt_min"></label>
    </div>
    <div class="test_row">
        <input type="submit" id="coapTest" value="Run CoAP Test" />
        <label id="coap_avg"></label>
        <label id="coap_max"></label>
        <label id="coap_min"></label>
    </div>    
    <script>
    $(document).ready(function () {                   
        var ws = new WebSocket("ws://" + window.location.host + "/ws");
        var t0 = 0.0;
        var max_time = 0.0;
        var min_time = 999999.9;
        var avg_time = 0.0;
        var t1 = 0.0;
        var numLoops = 30;        
        var loopCount = 0;
        var testRunning = false;

        ws.onopen = function(evt) {
            var conn_status = document.getElementById('conn_text');
            conn_status.innerHTML = "Connection status: Connected!"            
        };

        ws.onmessage = function(evt) {            
            t1 = performance.now();
            if (testRunning) {
                var elapsed_time = (t1 - t0);
                if (max_time < elapsed_time) {
                    max_time = elapsed_time;
                }

                if (min_time > elapsed_time) {
                    min_time = elapsed_time;
                }
                avg_time += elapsed_time;                    
                if (++loopCount >= numLoops) {
                    testRunning = false;
                    avg_time = avg_time / numLoops;
                    var message = document.getElementById('ws_result');
                    message.innerHTML = "Avg: " + avg_time.toFixed(1) + " ms - Max: " + max_time.toFixed(1) + 
                        " ms - Min: " + min_time.toFixed(1) + " ms";
                    max_time = 0.0; min_time = 999999.9; avg_time = 0.0; loopCount = 0;                    
                }
                else {
                    ws.send(evt.data);
                }
            }            
            var message = document.getElementById('response_txt');
            message.innerHTML = "Message received: " + evt.data;            

        };

        ws.onclose = function(evt) {
            alert ("Connection closed");
        };

        $("#websocketTest").click(function(evt) {                    
            var message = "webSocketTest";
            loopCount = 0;
            testRunning = true;
            t0 = performance.now();            
            ws.send(message);

	        evt.preventDefault();  
            for (count = 0; count < numLoops; count++) {
                
	            
                while (!messageReceived);                
                t1 = performance.now();
                messageReceived = false;
                var elapsed_time = (t1 - t0);
                if (max_time < elapsed_time) {
                    max_time = elapsed_time;
                }

                if (min_time > elapsed_time) {
                    min_time = elapsed_time;
                }
                avg_time += elapsed_time;                
            }            

            
        });
    });
    </script>
</body>
</html>
